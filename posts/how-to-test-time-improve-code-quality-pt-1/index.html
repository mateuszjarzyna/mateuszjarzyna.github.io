<!doctype html><html lang=en><head><title>How to test a code that uses time - improve quality of your project, part 1 ::
Mateusz Jarzyna</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Java has amazing java.time package. There are few useful classes like LocalDateTime, ZonedDateTime, Instant or Clock. But do you know how to use them? If you are using untestable Instant.now() syntax - you probably should read this post.
Concepts you must understand #  In the very first step, you must understand a few concepts that not everybody understood. If you know the theory, just skip to the section with code."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://mateuszjarzyna.github.io/posts/how-to-test-time-improve-code-quality-pt-1/><link rel=stylesheet href=https://mateuszjarzyna.github.io/assets/style.css><link rel=stylesheet href=https://mateuszjarzyna.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://mateuszjarzyna.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://mateuszjarzyna.github.io/img/favicon.png><link href=https://mateuszjarzyna.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mateuszjarzyna.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mateuszjarzyna.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mateuszjarzyna.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mateuszjarzyna.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://mateuszjarzyna.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="How to test a code that uses time - improve quality of your project, part 1"><meta name=twitter:description content="Java has amazing `java.time` package. There are few usefull classes like `LocalDateTime`, `ZonedDateTime`, `Instant` or `Clock`. But do you know how to use them? If you are using untestable `Instant.now()` syntax - you probably should read this post."><meta property="og:title" content="How to test a code that uses time - improve quality of your project, part 1"><meta property="og:description" content="Java has amazing `java.time` package. There are few usefull classes like `LocalDateTime`, `ZonedDateTime`, `Instant` or `Clock`. But do you know how to use them? If you are using untestable `Instant.now()` syntax - you probably should read this post."><meta property="og:type" content="article"><meta property="og:url" content="https://mateuszjarzyna.github.io/posts/how-to-test-time-improve-code-quality-pt-1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-16T15:00:00+00:00"><meta property="article:modified_time" content="2022-05-16T15:00:00+00:00"><meta property="og:site_name" content="Mateusz Jarzyna"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Mateusz Jarzyna</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>How to test a code that uses time - improve quality of your project, part 1</h1><div class=post-meta><span class=post-date>2022-05-16</span>
<span class=post-read-time>— 9 min read</span></div><div class=post-content><h2>Table of Contents</h2><aside class=table-of-contents><nav id=TableOfContents><ul><li><a href=#concepts-you-must-understand>Concepts you must understand</a><ul><li><a href=#timezones>Timezones</a></li><li><a href=#timestamp>Timestamp</a></li><li><a href=#timestamp-vs-local-date>Timestamp vs local date</a></li></ul></li><li><a href=#example-typical-app>Example, typical app</a><ul><li><a href=#clock>Clock</a></li><li><a href=#custom-time-provider>Custom time provider</a></li></ul></li></ul></nav></aside><p>Java has amazing <code>java.time</code> package. There are few useful classes like <code>LocalDateTime</code>, <code>ZonedDateTime</code>, <code>Instant</code> or <code>Clock</code>. But do you know how to use them? If you are using untestable <code>Instant.now()</code> syntax - you probably should read this post.</p><h2 id=concepts-you-must-understand>Concepts you must understand
<a href=#concepts-you-must-understand class=h-anchor aria-hidden=true>#</a></h2><p>In the very first step, you must understand a few concepts that not everybody understood. If you know the theory, just skip to the section with code.
Below, I will try to explain why always using <code>LocalDateTime</code> is not a good idea, and you most likely should use <code>ZonedDateTime</code> or <code>Instant</code>.</p><h3 id=timezones>Timezones
<a href=#timezones class=h-anchor aria-hidden=true>#</a></h3><p>Because the Earth is moving, rotating all the time, the noon is in only one place at a time. This means that in other places must be earlier or later.</p><p>Imagine having a friend on the other side of the globe. You ask him to call you afternoon&mldr;</p><img src=images/call-me.png class=center style=border-radius:8px><p>&mldr; but he doesn’t call and doesn’t answer his phone. Why?</p><img src=images/zzz.png class=center style=border-radius:8px><p>You ask him to call at 5pm, but 5pm at his region will be in 10 hours, but in your region, in your country the 5pm is right now. What you see on your watch is called <em>local time</em>. And your friend, on the other hand, has different local time. This is a known and already solved issue. Some years ago, some smart guy divided the Earth into smaller regions called the <strong>time zones</strong>. If you and your friend are both in the same time zone, it means that the sun rises approximately at the same time in your house and in his house.</p><p>You probably already known this and understand the concept perfectly. But when you are coding, you should consciously decide whether you need to operate on local time or on the time with a time zone.</p><h3 id=timestamp>Timestamp
<a href=#timestamp class=h-anchor aria-hidden=true>#</a></h3><p><code>2022-04-22T18:00:00.000Z</code> is the really nice representation of the date, humans like it. However, your computer doesn&rsquo;t. Machines prefer the numbers, one int > human-readable string. So, there is another representation of the date - timestamp. Timestamp is the point at the timeline.</p><p>Imagine an eruption of a volcano. The volcano exploded at 8am PST time, it was 8pm at ALMT zone. In the space, in the ISS was 2pm. The clue is that the eruption is an event on the Earth timeline.</p><img src=images/eruption.png class=center style=border-radius:8px><p>We can write a date referring to that event, as we do with years. You probably know the notation <em>Before Christ</em> or <em>Current Era</em>, 2022 BC/CE, similar concept.</p><img src=images/timeline.png class=center style=border-radius:8px><p>Now you can schedule a meeting with your friend using this precise notation.</p><img src=images/using-timestamp.png class=center style=border-radius:8px><p>In computer since, commonly used is <code>unix time</code>, the number of seconds (or milliseconds) that have elapsed since 1 January 1970, 00:00:00 UTC.</p><h3 id=timestamp-vs-local-date>Timestamp vs local date
<a href=#timestamp-vs-local-date class=h-anchor aria-hidden=true>#</a></h3><p>Short summary:</p><ul><li><em>Timestamp</em> - describe the point in Earth timeline. Represented by <code>Instant</code> class. Time-zone independent. It’s like a pointer to the global timeline.</li><li><em>Local date</em> - what you see on your watch. Represented by <code>LocalDateTime</code>, <code>LocalDate</code>, <code>LocalTime</code>.</li><li><em>Date with timezone</em> - time displayed on all watches in a some geographical area. Represented by <code>ZonedDateTime</code> and <code>ZoneId</code> classes. It’s like <code>Instant</code> with <code>ZoneId</code>.</li></ul><p>It’s critical to choose the right type for the problem and not mindlessly, always use LocalDateTime. You want to read more there is wonderful <a href=https://mattgreencroft.blogspot.com/2014/12/java-8-time-choosing-right-object.html>Java 8 Time - choosing the right object</a> and amazing <a href=https://stackoverflow.com/questions/32437550/whats-the-difference-between-instant-and-localdatetime>StackOverflow answer</a>.</p><p>Java has more useful classes like <code>DayOfWeek</code> or <code>Duration</code>, but we won’t focus on them.</p><h2 id=example-typical-app>Example, typical app
<a href=#example-typical-app class=h-anchor aria-hidden=true>#</a></h2><p>If you already know what representation of time you need, it’s time to code something. Let’s say you must create a piece of code that reset a user’s password. Simply generate a token and send via email. The token is valid for one hour. User has to use that token to set a new password. How can we achieve that?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ResetPasswordService</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ResetPasswordTokensRepository repository<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> EmailSender emailSender<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ResetPasswordService</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                ResetPasswordTokensRepository repository<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                EmailSender emailSender
</span></span><span style=display:flex><span>        <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>repository</span> <span style=color:#f92672>=</span> repository<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>emailSender</span> <span style=color:#f92672>=</span> emailSender<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendToken</span><span style=color:#f92672>(</span>UserId userId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            var validTill <span style=color:#f92672>=</span> Instant<span style=color:#f92672>.</span><span style=color:#a6e22e>now</span><span style=color:#f92672>().</span><span style=color:#a6e22e>plus</span><span style=color:#f92672>(</span>48<span style=color:#f92672>,</span> HOURS<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            var token <span style=color:#f92672>=</span> generateToken<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            var tokenEntity <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TokenEntity<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                    userId<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    token<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    validTill
</span></span><span style=display:flex><span>            <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            repository<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>tokenEntity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            emailSender<span style=color:#f92672>.</span><span style=color:#a6e22e>sendResetPassordEmail</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>,</span> token<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> Token <span style=color:#a6e22e>generateToken</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Token<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;xyz&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>resetPassword</span><span style=color:#f92672>(</span>UserId userId<span style=color:#f92672>,</span> Token token<span style=color:#f92672>,</span> Password newPass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            var entity <span style=color:#f92672>=</span> repository<span style=color:#f92672>.</span><span style=color:#a6e22e>findByUserIdAndToken</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>,</span> token<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>orElseThrow</span><span style=color:#f92672>(</span>TokenNotFoundException<span style=color:#f92672>::</span><span style=color:#66d9ef>new</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>entity<span style=color:#f92672>.</span><span style=color:#a6e22e>validTill</span><span style=color:#f92672>().</span><span style=color:#a6e22e>isAfter</span><span style=color:#f92672>(</span>Instant<span style=color:#f92672>.</span><span style=color:#a6e22e>now</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TokenExpiredException<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// rest password
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>This is a code you probably have seen many times in your career. In general, this code looks fine, but there are two lines we have to discuss.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>var validTill <span style=color:#f92672>=</span> Instant<span style=color:#f92672>.</span><span style=color:#a6e22e>now</span><span style=color:#f92672>().</span><span style=color:#a6e22e>plus</span><span style=color:#f92672>(</span>48<span style=color:#f92672>,</span> HOURS<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>It means that the token is valid for 48 hours from now.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>entity<span style=color:#f92672>.</span><span style=color:#a6e22e>validTill</span><span style=color:#f92672>().</span><span style=color:#a6e22e>isAfter</span><span style=color:#f92672>(</span>Instant<span style=color:#f92672>.</span><span style=color:#a6e22e>now</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span></code></pre></div><p>Here we are checking if the token is still valid.</p><p>Can we test these two methods? We can, but no easy, not fully and <em>dirty</em>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>should_generate_token</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var service <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ResetPasswordService<span style=color:#f92672>(</span>testRepository<span style=color:#f92672>,</span> mockedEmailSender<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        service<span style=color:#f92672>.</span><span style=color:#a6e22e>sendToken</span><span style=color:#f92672>(</span>testUserId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        assertThat<span style=color:#f92672>(</span>mockedEmailSender<span style=color:#f92672>.</span><span style=color:#a6e22e>lastRestPasswordEmail</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>hasToken</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;xyz&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>isInTheFuture</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>During the test, we generated the token and verified the email that was sent to a user. We can assert the token, but we cannot assert the validity time. I mean, we can check if it’s not null and if it is in the future, but there is no easy way to assert the value. The value should be <code>Instant.now().minus(few, MILLISECONDS)</code>, but we don’t know the exact value, only approximately, with few milliseconds&rsquo; epsilon.
Maybe we can unit test the <code>restPassword</code> method? Let’s see what we can do.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>should_throw_exception_when_token_is_expired</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var newPass <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Password<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;some-password-123$%^&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var token <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Token<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;xyz&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var tokenEntity <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TokenEntity<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                userId<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>                token<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                Instant<span style=color:#f92672>.</span><span style=color:#a6e22e>now</span><span style=color:#f92672>().</span><span style=color:#a6e22e>minus</span><span style=color:#f92672>(</span>100<span style=color:#f92672>,</span> DAYS<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        testRepository<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>tokenEntity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        var service <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ResetPasswordService<span style=color:#f92672>(</span>testRepository<span style=color:#f92672>,</span> mockedEmailSender<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        assertThrown<span style=color:#f92672>(</span>TokenExpiredException<span style=color:#f92672>::</span>class<span style=color:#f92672>,</span> <span style=color:#f92672>()</span> <span style=color:#f92672>-&gt;</span> service<span style=color:#f92672>.</span><span style=color:#a6e22e>resetPassword</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>,</span> token<span style=color:#f92672>,</span> newPass<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>should_reset_password_when_token_is_valid</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var newPass <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Password<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;some-password-123$%^&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var token <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Token<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;xyz&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var tokenEntity <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TokenEntity<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                userId<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>                token<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                Instant<span style=color:#f92672>.</span><span style=color:#a6e22e>now</span><span style=color:#f92672>().</span><span style=color:#a6e22e>minus</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> HOURS<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        testRepository<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>tokenEntity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        var service <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ResetPasswordService<span style=color:#f92672>(</span>testRepository<span style=color:#f92672>,</span> mockedEmailSender<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        service<span style=color:#f92672>.</span><span style=color:#a6e22e>resetPassword</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>,</span> token<span style=color:#f92672>,</span> newPass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        assertThat<span style=color:#f92672>(</span>userId<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>hasPassword</span><span style=color:#f92672>(</span>newPass<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>As you can see, we can test the <code>resetPassword</code> method. But are these test goods? As you can see, we have to insert entities directly to the database. Also, we have to simulate the time when the token was generated. Unit tests should not insert any data to the repository, we do it better.</p><h3 id=clock>Clock
<a href=#clock class=h-anchor aria-hidden=true>#</a></h3><p>Java has the <code>Clock</code> class. For the first time the class seems to be useless, calling the <code>clock.instant()</code> gives you the same result as <code>Instant.now()</code>, but <code>Clock</code> has no static method, and you have to inject an additional bean. Looks like overkill, but the advantage is that we can inject different implementation during the tests. Try to add the Clock to our service class.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ResetPasswordService</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ResetPasswordTokensRepository repository<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> EmailSender emailSender<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Clock clock<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ResetPasswordService</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                ResetPasswordTokensRepository repository<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                EmailSender emailSender<span style=color:#f92672>,</span> 
</span></span><span style=display:flex><span>                Clock clock
</span></span><span style=display:flex><span>        <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>repository</span> <span style=color:#f92672>=</span> repository<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>emailSender</span> <span style=color:#f92672>=</span> emailSender<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>clock</span> <span style=color:#f92672>=</span> clock<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendToken</span><span style=color:#f92672>(</span>UserId userId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            var validTill <span style=color:#f92672>=</span> clock<span style=color:#f92672>.</span><span style=color:#a6e22e>instant</span><span style=color:#f92672>().</span><span style=color:#a6e22e>plus</span><span style=color:#f92672>(</span>48<span style=color:#f92672>,</span> HOURS<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>						<span style=color:#75715e>// send token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>resetPassword</span><span style=color:#f92672>(</span>UserId userId<span style=color:#f92672>,</span> Token token<span style=color:#f92672>,</span> Password newPass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            var entity <span style=color:#f92672>=</span> repository<span style=color:#f92672>.</span><span style=color:#a6e22e>findByUserIdAndToken</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>,</span> token<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>.</span><span style=color:#a6e22e>orElseThrow</span><span style=color:#f92672>(</span>TokenNotFoundException<span style=color:#f92672>::</span><span style=color:#66d9ef>new</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>entity<span style=color:#f92672>.</span><span style=color:#a6e22e>validTill</span><span style=color:#f92672>().</span><span style=color:#a6e22e>isAfter</span><span style=color:#f92672>(</span>clock<span style=color:#f92672>.</span><span style=color:#a6e22e>instant</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TokenExpiredException<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// rest password
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			
</span></span><span style=display:flex><span>				<span style=color:#75715e>// ....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>So, we have added a new dependency. But the app won’t run, there is no <code>Clock</code> bean. However, it’s easy to add it</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ClockConfiguration</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> ZoneId TIME_ZONE <span style=color:#f92672>=</span> ZoneId<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;UTC&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    Clock <span style=color:#a6e22e>clock</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Clock<span style=color:#f92672>.</span><span style=color:#a6e22e>system</span><span style=color:#f92672>(</span>TIME_ZONE<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>There is one thing to explain</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>clock<span style=color:#f92672>.</span><span style=color:#a6e22e>system</span><span style=color:#f92672>(</span>TIME_ZONE<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>It’s the implementation of the clock that return the time from the system clock. We have to provide some time zone, the zone is use <em>to convert the instant to zoned date-time</em>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>should_generate_token</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var today <span style=color:#f92672>=</span> Instant<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;2022-04-22T18:00:00.000Z&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        var testClock <span style=color:#f92672>=</span> Clock<span style=color:#f92672>.</span><span style=color:#a6e22e>fixed</span><span style=color:#f92672>(</span>today<span style=color:#f92672>,</span> ZoneId<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;UTC&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        var service <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ResetPasswordService<span style=color:#f92672>(</span>testRepository<span style=color:#f92672>,</span> mockedEmailSende<span style=color:#f92672>,</span>  testClock<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        service<span style=color:#f92672>.</span><span style=color:#a6e22e>sendToken</span><span style=color:#f92672>(</span>testUserId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        assertThat<span style=color:#f92672>(</span>mockedEmailSender<span style=color:#f92672>.</span><span style=color:#a6e22e>lastRestPasswordEmail</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>hasToken</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;xyz&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>isValidTill</span><span style=color:#f92672>(</span>Instant<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;2022-04-23T18:00:00.000Z&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>But there is still a problem with the <code>resetPassword</code> method, we still must insert the token manually. What can we do to resolve that issue and create the perfect test?</p><h3 id=custom-time-provider>Custom time provider
<a href=#custom-time-provider class=h-anchor aria-hidden=true>#</a></h3><p>We can create another interface, very similar to the <code>Clock</code> (or use <code>InstantSource</code> added with Java 17)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>TimeProvider</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Instant <span style=color:#a6e22e>instant</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Next, replace usage of <code>Clock</code> with our <code>TimeProvider</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ResetPasswordService</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ResetPasswordTokensRepository repository<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> EmailSender emailSender<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> TimeProvider timeProvider<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ResetPasswordService</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            ResetPasswordTokensRepository repository<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            EmailSender emailSender<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            TimeProvider timeProvider
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>repository</span> <span style=color:#f92672>=</span> repository<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>emailSender</span> <span style=color:#f92672>=</span> emailSender<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>timeProvider</span> <span style=color:#f92672>=</span> timeProvider<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendToken</span><span style=color:#f92672>(</span>UserId userId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        var validTill <span style=color:#f92672>=</span> timeProvider<span style=color:#f92672>.</span><span style=color:#a6e22e>instant</span><span style=color:#f92672>().</span><span style=color:#a6e22e>plus</span><span style=color:#f92672>(</span>48<span style=color:#f92672>,</span> HOURS<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ..
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>resetPassword</span><span style=color:#f92672>(</span>UserId userId<span style=color:#f92672>,</span> Token token<span style=color:#f92672>,</span> Password newPass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>entity<span style=color:#f92672>.</span><span style=color:#a6e22e>validTill</span><span style=color:#f92672>().</span><span style=color:#a6e22e>isAfter</span><span style=color:#f92672>(</span>timeProvider<span style=color:#f92672>.</span><span style=color:#a6e22e>instant</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TokenExpiredException<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Finally, create implementation and register a bean</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ResetPasswordService</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ResetPasswordTokensRepository repository<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> EmailSender emailSender<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> TimeProvider timeProvider<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ResetPasswordService</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                ResetPasswordTokensRepository repository<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                EmailSender emailSender<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                TimeProvider timeProvider
</span></span><span style=display:flex><span>        <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>repository</span> <span style=color:#f92672>=</span> repository<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>emailSender</span> <span style=color:#f92672>=</span> emailSender<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>timeProvider</span> <span style=color:#f92672>=</span> timeProvider<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendToken</span><span style=color:#f92672>(</span>UserId userId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            var validTill <span style=color:#f92672>=</span> timeProvider<span style=color:#f92672>.</span><span style=color:#a6e22e>instant</span><span style=color:#f92672>().</span><span style=color:#a6e22e>plus</span><span style=color:#f92672>(</span>48<span style=color:#f92672>,</span> HOURS<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ..
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>resetPassword</span><span style=color:#f92672>(</span>UserId userId<span style=color:#f92672>,</span> Token token<span style=color:#f92672>,</span> Password newPass<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>entity<span style=color:#f92672>.</span><span style=color:#a6e22e>validTill</span><span style=color:#f92672>().</span><span style=color:#a6e22e>isAfter</span><span style=color:#f92672>(</span>timeProvider<span style=color:#f92672>.</span><span style=color:#a6e22e>instant</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> TokenExpiredException<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>You may think this is all pointless, the <code>TimeProvider</code> interface boils down to <code>Instant.now()</code> call. It may look overcomplicated, but wait for second, test’s implementation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestTimeProvider</span> <span style=color:#66d9ef>implements</span> TimeProvider <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Clock clock<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>TestTimeProvider</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>(</span>Instant<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;2022-04-22T18:00:00.000Z&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>TestTimeProvider</span><span style=color:#f92672>(</span>Instant initInstant<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>clock</span> <span style=color:#f92672>=</span> buildClock<span style=color:#f92672>(</span>initInstant<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Instant <span style=color:#a6e22e>instant</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> clock<span style=color:#f92672>.</span><span style=color:#a6e22e>instant</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>elapse</span><span style=color:#f92672>(</span>TemporalAmount temporalAmount<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        clock <span style=color:#f92672>=</span>  buildClock<span style=color:#f92672>(</span>instant<span style=color:#f92672>().</span><span style=color:#a6e22e>plus</span><span style=color:#f92672>(</span>temporalAmount<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>elapse</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> amountToAdd<span style=color:#f92672>,</span> TemporalUnit unit<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        clock <span style=color:#f92672>=</span>  buildClock<span style=color:#f92672>(</span>instant<span style=color:#f92672>().</span><span style=color:#a6e22e>plus</span><span style=color:#f92672>(</span>amountToAdd<span style=color:#f92672>,</span> unit<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Clock <span style=color:#a6e22e>buildClock</span><span style=color:#f92672>(</span>Instant instant<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Clock<span style=color:#f92672>.</span><span style=color:#a6e22e>fixed</span><span style=color:#f92672>(</span>instant<span style=color:#f92672>,</span> ZoneId<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;UTC&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>And if you have integration tests, just register new, test&rsquo;s bean</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>		<span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestBeans</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Primary</span>
</span></span><span style=display:flex><span>        TestTimeProvider <span style=color:#a6e22e>testTimeProvider</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TestTimeProvider<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>I hope it starts to make sense. We’ve created the class that allows us to <em>time travel</em> during the tests. How to use it?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    TestTimeProvider timeProvider <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TestTimeProvider<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    ResetPasswordService service <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ResetPasswordService<span style=color:#f92672>(</span>testRepository<span style=color:#f92672>,</span> mockedEmailSender<span style=color:#f92672>,</span> timeProvider<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>should_throw_exception_when_token_is_expired</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// given
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        var newPass <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Password<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;some-password-123$%^&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        service<span style=color:#f92672>.</span><span style=color:#a6e22e>sendToken</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        var token <span style=color:#f92672>=</span> mockedEmailSender<span style=color:#f92672>.</span><span style=color:#a6e22e>getTokenFromEmail</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// when
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        timeProvider<span style=color:#f92672>.</span><span style=color:#a6e22e>elapse</span><span style=color:#f92672>(</span>100<span style=color:#f92672>,</span> DAYS<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// then
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        assertThrown<span style=color:#f92672>(</span>TokenExpiredException<span style=color:#f92672>::</span>class<span style=color:#f92672>,</span> <span style=color:#f92672>()</span> <span style=color:#f92672>-&gt;</span> service<span style=color:#f92672>.</span><span style=color:#a6e22e>resetPassword</span><span style=color:#f92672>(</span>userId<span style=color:#f92672>,</span> token<span style=color:#f92672>,</span> newPass<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>See? We can simulate the passage of time by calling <code>timeProvider.elapse(100, DAYS);</code> and peek current instant during the test by calling <code>timeProvider.instant()</code>. It’s why we created a seemingly useless interface.</p><p>I hope you will add the <code>TimeProvider</code> to your next project, happy testing!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://mateuszjarzyna.github.io/posts/build-your-own-http-server-in-java-in-less-than-one-hour-only-get-method/><span class=button__text>Build your own HTTP server in Java in less than one hour (only GET method)</span>
<span class=button__icon>→</span></a></span></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//mateuszjarzyna-github-io.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Mateusz Jarzyna</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2022 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://mateuszjarzyna.github.io/assets/main.js></script>
<script src=https://mateuszjarzyna.github.io/assets/prism.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VC5ZBY5XE8"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VC5ZBY5XE8",{anonymize_ip:!1})}</script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-VC5ZBY5XE8"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VC5ZBY5XE8",{anonymize_ip:!1})}</script></body></html>